<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Traffic Round Robin Solver with Vehicle Animation and Traffic Lights</title>
<style>
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: #f0f4f8;
    color: #333;
    margin: 0; padding: 20px;
  }
  header {
    text-align: center;
    margin-bottom: 20px;
  }
  h1 {
    color: #2a5d9f;
  }
  input[type="file"] {
    display: block;
    margin: 0 auto 10px auto;
  }
  #controls {
    text-align: center;
    margin-bottom: 20px;
  }
  #result {
    background: #fff;
    border-radius: 8px;
    padding: 20px;
    max-width: 900px;
    margin: 10px auto;
    box-shadow: 0 2px 12px rgb(0 0 0 / 0.1);
  }
  table {
    width: 100%;
    border-collapse: collapse;
    margin-top: 15px;
  }
  th, td {
    border: 1px solid #ddd;
    padding: 8px 12px;
    text-align: center;
  }
  th {
    background-color: #2a5d9f;
    color: white;
  }
  .priority {
    background-color: #f8d568;
  }
  .ambulance {
    font-weight: bold;
    color: #d13438;
  }
  button {
    background-color: #2a5d9f;
    color: white;
    border: none;
    padding: 10px 18px;
    border-radius: 5px;
    font-size: 1em;
    cursor: pointer;
    margin: 10px 5px 0 5px;
    min-width: 130px;
  }
  button:disabled {
    background-color: #999999;
    cursor: not-allowed;
  }
  button:hover:enabled {
    background-color: #234978;
  }
  #animation-area {
    margin: 30px auto;
    max-width: 600px;
    height: 420px;
    position: relative;
    background: #e2e8f0;
    border-radius: 12px;
    box-shadow: inset 0 0 10px rgb(0 0 0 / 0.05);
    display: flex;
    justify-content: center;
    align-items: center;
  }

  .direction-node {
    position: absolute;
    width: 130px;
    height: 90px;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 8px rgb(0 0 0 / 0.12);
    text-align: center;
    padding: 10px;
    transition: box-shadow 0.3s ease, background-color 0.3s ease;
    user-select: none;
    z-index: 2;
  }

  .direction-label {
    font-weight: bold;
    font-size: 1.2rem;
    margin-bottom: 5px;
    color: #2a5d9f;
  }

  .vehicle-type {
    font-size: 1rem;
    margin-top: 4px;
  }

  .active {
    background-color: #2a5d9f;
    color: white !important;
    box-shadow: 0 0 16px 4px #2a5d9fcc;
    z-index: 10;
  }

  .ambulance-active {
    background-color: #d13238;
    box-shadow: 0 0 20px 6px #d13238cc;
    color: white !important;
  }

  /* Position four directions clockwise */
  #dir-front { top: 30px; left: calc(50% - 65px); }  /* top center */
  #dir-right { top: calc(50% - 45px); right: 30px; } /* right center */
  #dir-back { bottom: 30px; left: calc(50% - 65px); } /* bottom center */
  #dir-left { top: calc(50% - 45px); left: 30px; } /* left center */

  .indicator-light {
    width: 20px;
    height: 20px;
    border-radius: 50%;
    margin: 4px auto 0;
    background-color: #bbb;
    box-shadow: inset 0 0 5px #999;
  }
  .indicator-light.green {
    background-color: #38b000;
    box-shadow: 0 0 10px #38b000cc;
  }
  .indicator-light.red {
    background-color: #d13238;
  }

  #vehicle-animation {
    position: absolute;
    width: 40px;
    height: 20px;
    background-color: #2a5d9f;
    border-radius: 4px;
    color: white;
    font-size: 0.7rem;
    text-align: center;
    line-height: 20px;
    font-weight: bold;
    pointer-events: none;
    z-index: 100;
    user-select: none;
  }

  #vehicle-animation.ambulance {
    background-color: #d13238;
  }

  /* Traffic light container positioned near direction nodes */
  .traffic-light {
    position: absolute;
    width: 24px;
    height: 60px;
    background: #222;
    border-radius: 8px;
    box-shadow: 0 0 5px rgba(0,0,0,0.7);
    display: flex;
    flex-direction: column;
    justify-content: space-around;
    align-items: center;
    padding: 4px 0;
    z-index: 3;
  }

  .light-circle {
    width: 16px;
    height: 16px;
    background: #400000;
    border-radius: 50%;
    box-shadow: inset 0 0 6px #600000;
    transition: background-color 0.4s ease-in-out, box-shadow 0.4s ease-in-out;
  }

  .light-circle.red {
    background: #d13238;
    box-shadow: 0 0 10px #d13238cc;
  }
  .light-circle.yellow {
    background: #d1bc38;
    box-shadow: 0 0 10px #d1bc3899;
  }
  .light-circle.green {
    background: #38b000;
    box-shadow: 0 0 10px #38b000cc;
  }

  /* Position traffic lights near direction nodes */

  #tl-front {
    top: 125px;
    left: calc(50% - 12px);
  }
  #tl-right {
    top: calc(50% - 25px);
    right: 170px;
  }
  #tl-back {
    bottom: 125px;
    left: calc(50% - 12px);
  }
  #tl-left {
    top: calc(50% - 25px);
    left: 170px;
  }
</style>
</head>
<body>
<header>
  <h1>Traffic Round Robin Solver with Vehicle Animation and Traffic Lights</h1>
  <p>Upload Excel file with vehicle data from all 4 directions and watch vehicles pass the road with traffic light signals</p>
</header>

<div id="controls" style="text-align:center;">
  <input type="file" id="file-input" accept=".xlsx, .xls" />
  <button id="solve-btn" disabled>Compute Traffic Schedule</button>
  <button id="start-anim-btn" disabled>Start Animation</button>
  <button id="reset-btn" disabled>Reset</button>
</div>

<div id="result"></div>

<div id="animation-area" aria-label="Traffic directions animation area" role="region" aria-live="polite">
  <div id="dir-front" class="direction-node" aria-label="Front direction">
    <div class="direction-label">Front</div>
    <div class="vehicle-type" id="front-vehicle">—</div>
    <div class="indicator-light" id="light-front"></div>
  </div>
  <div class="traffic-light" id="tl-front" aria-hidden="true">
    <div class="light-circle red"></div>
    <div class="light-circle yellow"></div>
    <div class="light-circle green"></div>
  </div>
  <div id="dir-right" class="direction-node" aria-label="Right direction">
    <div class="direction-label">Right</div>
    <div class="vehicle-type" id="right-vehicle">—</div>
    <div class="indicator-light" id="light-right"></div>
  </div>
  <div class="traffic-light" id="tl-right" aria-hidden="true">
    <div class="light-circle red"></div>
    <div class="light-circle yellow"></div>
    <div class="light-circle green"></div>
  </div>
  <div id="dir-back" class="direction-node" aria-label="Back direction">
    <div class="direction-label">Back</div>
    <div class="vehicle-type" id="back-vehicle">—</div>
    <div class="indicator-light" id="light-back"></div>
  </div>
  <div class="traffic-light" id="tl-back" aria-hidden="true">
    <div class="light-circle red"></div>
    <div class="light-circle yellow"></div>
    <div class="light-circle green"></div>
  </div>
  <div id="dir-left" class="direction-node" aria-label="Left direction">
    <div class="direction-label">Left</div>
    <div class="vehicle-type" id="left-vehicle">—</div>
    <div class="indicator-light" id="light-left"></div>
  </div>
  <div class="traffic-light" id="tl-left" aria-hidden="true">
    <div class="light-circle red"></div>
    <div class="light-circle yellow"></div>
    <div class="light-circle green"></div>
  </div>
  <div id="vehicle-animation" aria-hidden="true" style="display:none;">V</div>
</div>

<!-- SheetJS CDN -->
<script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
<script>
  const fileInput = document.getElementById('file-input');
  const solveBtn = document.getElementById('solve-btn');
  const startAnimBtn = document.getElementById('start-anim-btn');
  const resetBtn = document.getElementById('reset-btn');
  const resultDiv = document.getElementById('result');

  let trafficData = {};
  let schedule = [];
  let animationTimer = null;
  let currentTurnIndex = 0;

  const vehicleAnimation = document.getElementById('vehicle-animation');
  const animationArea = document.getElementById('animation-area');

  // Coordinates for each direction node center relative to animationArea
  const directionPositions = {
    front: { x: 300, y: 75 },  // top center
    right: { x: 570, y: 180 }, // right center
    back: { x: 300, y: 355 },  // bottom center
    left: { x: 55, y: 180 }    // left center
  };

  // Traffic light elements for each direction
  const trafficLights = {
    front: document.getElementById('tl-front'),
    right: document.getElementById('tl-right'),
    back: document.getElementById('tl-back'),
    left: document.getElementById('tl-left')
  };

  // Vehicle travel paths - from each direction node center to center (simulate crossing)
  // The vehicle will move from its direction node to center of 'road' (center of animation area)
  // For animation sake, center is approx (300, 180)
  const roadCenter = { x: 300, y: 180 };

  function parseExcelFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = (e) => {
        try {
          const data = new Uint8Array(e.target.result);
          const workbook = XLSX.read(data, {type: 'array'});
          const sheetName = workbook.SheetNames[0];
          const worksheet = workbook.Sheets[sheetName];
          const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval:""});
          resolve(jsonData);
        } catch (error) {
          reject(error);
        }
      };
      reader.onerror = (e) => {
        reject(e);
      };
      reader.readAsArrayBuffer(file);
    });
  }

  function organizeTrafficData(rawData) {
    const organized = {};
    rawData.forEach(row => {
      const dir = (row.Direction || row.direction || '').toString();
      const vType = (row.Vehicle_Type || row.vehicleType || '').toString();
      const count = parseInt(row.Count || row.count || 0);
      if(!dir || !vType || isNaN(count)) return;
      if (!organized[dir]) organized[dir] = {};
      if (!organized[dir][vType]) organized[dir][vType] = 0;
      organized[dir][vType] += count;
    });
    return organized;
  }

  function solveTrafficSchedule(data) {
    const directions = Object.keys(data);
    const ambulanceTurns = [];
    const normalTurnQueues = {};

    // Separate ambulances and normal vehicles counts
    directions.forEach(dir => {
      normalTurnQueues[dir] = [];
      const vTypes = data[dir];

      for (const [v, c] of Object.entries(vTypes)) {
        if (v === 'Ambulance') {
          for (let i = 0; i < c; i++) {
            ambulanceTurns.push({direction: dir, vehicle: v, priority: true});
          }
          data[dir][v] = 0; // Clear ambulances count
        }
      }
    });

    // After clearing ambulances, build queues for normal vehicles
    directions.forEach(dir => {
      const vTypes = data[dir];
      for (const [v, c] of Object.entries(vTypes)) {
        if (v !== 'Ambulance' && c > 0) {
          for (let i = 0; i < c; i++) {
            normalTurnQueues[dir].push(v);
          }
        }
      }
    });

    // Round robin scheduling for normal vehicles
    const normalSchedule = [];
    let normalActive = true;
    while (normalActive) {
      normalActive = false;
      for (const dir of directions) {
        if (normalTurnQueues[dir].length > 0) {
          const vehicle = normalTurnQueues[dir].shift();
          normalSchedule.push({direction: dir, vehicle: vehicle, priority: false});
          normalActive = true;
        }
      }
    }

    // Compose final schedule: ambulances first, then normal vehicles
    const finalSchedule = ambulanceTurns.concat(normalSchedule);
    return finalSchedule;
  }

  function renderDataTable(data) {
    let html = "<h2>Traffic Data Loaded</h2>";
    html += '<table><thead><tr><th>Direction</th><th>Vehicle Type</th><th>Count</th></tr></thead><tbody>';
    Object.entries(data).forEach(([dir, vehicles]) => {
      Object.entries(vehicles).forEach(([vType, count]) => {
        if(count > 0)
          html += `<tr><td>${dir}</td><td>${vType}</td><td>${count}</td></tr>`;
      });
    });
    html += '</tbody></table>';
    return html;
  }

  function resetAnimationUI() {
    ['front','right','back','left'].forEach(dir => {
      const vehText = document.getElementById(dir + '-vehicle');
      const node = document.getElementById('dir-' + dir);
      const light = document.getElementById('light-' + dir);
      vehText.textContent = '—';
      node.classList.remove('active', 'ambulance-active');
      light.className = 'indicator-light';
      light.style.backgroundColor = '';
      light.style.boxShadow = '';
      // Reset traffic lights to red and off
      const tl = trafficLights[dir];
      if(tl){
        const lights = tl.querySelectorAll('.light-circle');
        lights.forEach(l => l.className = 'light-circle');
        // Set red light on initially
        if(lights.length > 0) lights[0].classList.add('red');
      }
    });
    vehicleAnimation.style.display = 'none';
    vehicleAnimation.style.transition = '';
    vehicleAnimation.style.left = '0px';
    vehicleAnimation.style.top = '0px';
    vehicleAnimation.textContent = 'V';
    vehicleAnimation.classList.remove('ambulance');
  }

  async function animateVehiclePass(dir, vehicle, duration=1200) {
    return new Promise(resolve => {
      const startPos = directionPositions[dir];
      const endPos = roadCenter;

      vehicleAnimation.style.display = 'block';
      vehicleAnimation.textContent = vehicle[0].toUpperCase(); // show first letter
      if(vehicle.toLowerCase() === 'ambulance'){
        vehicleAnimation.classList.add('ambulance');
      } else {
        vehicleAnimation.classList.remove('ambulance');
      }

      // Place vehicle at start
      vehicleAnimation.style.transition = 'none';
      vehicleAnimation.style.left = (startPos.x - 20) + 'px'; // center horizontally subtract half vehicle width (40/2)
      vehicleAnimation.style.top = (startPos.y - 10) + 'px';  // center vertically subtract half vehicle height (20/2)

      // Allow layout
      requestAnimationFrame(() => {
        // Move vehicle to road center with transition
        vehicleAnimation.style.transition = `left ${duration}ms linear, top ${duration}ms linear`;
        vehicleAnimation.style.left = (endPos.x - 20) + 'px';
        vehicleAnimation.style.top = (endPos.y - 10) + 'px';
      });

      setTimeout(() => {
        // Hide vehicle after reach center
        vehicleAnimation.style.display = 'none';
        resolve();
      }, duration + 200);
    });
  }

  // Turn traffic light green for the given direction, and others red
  function setTrafficLightGreen(direction) {
    for(const dir in trafficLights) {
      const tl = trafficLights[dir];
      const lights = tl.querySelectorAll('.light-circle');
      if(dir === direction) {
        lights.forEach(l => l.className = 'light-circle');
        if(lights.length >= 3) {
          // green on
          lights[0].classList.remove('red');
          lights[1].classList.remove('yellow');
          lights[2].classList.add('green');
        }
      } else {
        // Red on and others off
        lights.forEach(l => l.className = 'light-circle');
        if(lights.length >= 1) lights[0].classList.add('red');
      }
    }
  }

  async function animateSchedule(){
    if(currentTurnIndex >= schedule.length){
      clearInterval(animationTimer);
      alert('Traffic schedule animation complete.');
      startAnimBtn.disabled = false;
      resetBtn.disabled = false;
      // Reset all traffic lights to red on end
      setTrafficLightGreen(null);
      return;
    }

    resetAnimationUI();

    const currentTurn = schedule[currentTurnIndex];
    const dir = currentTurn.direction.toLowerCase();
    const veh = currentTurn.vehicle;
    const isAmbulance = currentTurn.priority;

    // Highlight current direction node and vehicle
    const node = document.getElementById('dir-' + dir);
    const vehText = document.getElementById(dir + '-vehicle');
    const light = document.getElementById('light-' + dir);
    vehText.textContent = veh;

    if(isAmbulance){
      node.classList.add('ambulance-active');
      light.classList.add('green');
      light.style.backgroundColor = '#d13238';
      light.style.boxShadow = '0 0 15px 6px #d13238cc';
    } else {
      node.classList.add('active');
      light.classList.add('green');
      light.style.backgroundColor = '#38b000';
      light.style.boxShadow = '0 0 15px 6px #38b000cc';
    }

    setTrafficLightGreen(dir);
    await animateVehiclePass(dir, veh);

    currentTurnIndex++;
    animationTimer = setTimeout(animateSchedule, 400); // pause a bit before next turn
  }

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    resultDiv.innerHTML = "";
    solveBtn.disabled = true;
    startAnimBtn.disabled = true;
    resetBtn.disabled = true;
    resetAnimationUI();
    schedule = [];
    currentTurnIndex = 0;
    trafficData = {};

    if(!file) return;

    try {
      const rawData = await parseExcelFile(file);
      trafficData = organizeTrafficData(rawData);
      resultDiv.innerHTML = renderDataTable(trafficData);
      solveBtn.disabled = false;
    } catch(err) {
      resultDiv.innerHTML = `<p style="color:red;">Error reading file: ${err}</p>`;
    }
  });

  solveBtn.addEventListener('click', () => {
    if(!trafficData || Object.keys(trafficData).length === 0) {
      alert("No traffic data loaded.");
      return;
    }
    schedule = solveTrafficSchedule(JSON.parse(JSON.stringify(trafficData)));
    resultDiv.innerHTML += "<h2>Traffic Schedule</h2><p>Ready to animate the traffic passage.</p>";
    startAnimBtn.disabled = false;
    resetBtn.disabled = false;
  });

  startAnimBtn.addEventListener('click', () => {
    if(schedule.length === 0) {
      alert("No schedule to animate. Compute schedule first.");
      return;
    }
    solveBtn.disabled = true;
    startAnimBtn.disabled = true;
    resetBtn.disabled = true;
    currentTurnIndex = 0;
    animateSchedule();
  });

  resetBtn.addEventListener('click', () => {
    clearTimeout(animationTimer);
    resetAnimationUI();
    currentTurnIndex = 0;
    schedule = [];
    trafficData = {};
    solveBtn.disabled = true;
    startAnimBtn.disabled = true;
    resetBtn.disabled = true;
    resultDiv.innerHTML = "";
    fileInput.value = "";
    setTrafficLightGreen(null);
  });
</script>
</body>
</html>

